---
title: 宏任务与微任务
date: 2021-10-21 14:29:15
tags: ["宏任务/微任务"]
categories: 甲骨文
---

### 今天进行了人生中的第一次面试。结果凉凉了。但是还是学到了很多东西。其中在面试时面试官问了我一道题

```js
setTimeout(function () {
  console.log("1");
});
new Promise(function (resolve) {
  console.log("2");
  resolve();
}).then(function () {
  console.log("3");
});

console.log("4");
```

请你给出这段代码的运行顺序。当时我就蒙犊子了。同步异步我看过很多的讲解，大多都是要么你就一个 setTimeout 函数，要么就一个 Promise 函数。两个函数放到一起的我还真没见过。于是我就想：

settimeout 肯定是异步的。 我也知道有一个 event 队列，你 settimeout 没设置时间应该直接就进入这个队列了吧，然后就是 Promise 的回掉函数进入 event 队列。 当时我二话不说给了个答案 2，4，1，3.并且很自信。然后面试官就问你不想想了?我说不想了。然后后半段他全程开始皱眉头了。我也凉凉。最后他让我回去看一下宏任务和微任务。

首先说一下普通的异步函数的执行过程吧：

同步和异步任务分别进入不同的执行"场所"，同步的进入主线程，异步的进入 Event Table 并注册函数。当指定的事情完成时，Event Table 会将这个函数移入 Event Queue。主线程内的任务执行完毕为空，会去 Event Queue 读取对应的函数，进入主线程执行。上述过程会不断重复，也就是常说的 Event Loop(事件循环)。

![img](https://img-blog.csdn.net/2018041120124254?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xjMjM3NDIzNTUx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

图文我是转载的一个掘金的老哥的文章里的。他叫：ssssyoki

# ssssyoki

那么如此看来我给的答案还是对的。但是 js 异步有一个机制，就是遇到宏任务，先执行宏任务，将宏任务放入 eventqueue，然后在执行微任务，将微任务放入 eventqueue 最骚的是，这两个 queue 不是一个 queue。当你往外拿的时候先从微任务里拿这个回掉函数，然后再从宏任务的 queue 上拿宏任务的回掉函数。 我当时看到这我就服了还有这种骚操作。

再盗个图

![img](https://img-blog.csdn.net/20180411202638415?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xjMjM3NDIzNTUx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

而宏任务一般是：包括整体代码 script，setTimeout，setInterval。

微任务：Promise，process.nextTick。

记住就行了。

然后回到开头的代码。因为 settimeout 是宏任务，虽然先执行的他，但是他被放到了宏任务的 eventqueue 里面，然后代码继续往下检查看有没有微任务，检测到 Promise 的 then 函数把他放入了微任务序列。等到主线进程的所有代码执行结束后。先从微任务 queue 里拿回掉函数，然后微任务 queue 空了后再从宏任务的 queue 拿函数。

所以正确的执行结果当然是：2，4，3，1。

如果还是不懂得同学可以去看一下这个老哥的文章，总结的挺到位的。向他学习。点击打开链接

```http
https://juejin.cn/post/6844903512845860872
```
